<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{backoffice/layout :: layout(~{::title}, ~{::main})}">
<head>
    <title th:text="${venteProduit.idVenteProduit != null} ? 'Modifier Vente' : 'Nouvelle Vente'"></title>
</head>
<body>
<main style="margin-left: 0; padding: 20px;">
    <div class="mb-4">
        <h2 th:text="${venteProduit.idVenteProduit != null} ? 'Modifier Vente' : 'Nouvelle Vente'"></h2>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a th:href="@{/admin/vente-produits}">Ventes</a></li>
                <li class="breadcrumb-item active" aria-current="page" 
                    th:text="${venteProduit.idVenteProduit != null} ? 'Modifier' : 'Nouvelle'"></li>
            </ol>
        </nav>
    </div>

    <div class="card">
        <div class="card-body">
            <form th:action="@{/admin/vente-produits}" th:object="${venteProduit}" method="post">
                <input type="hidden" th:field="*{idVenteProduit}" />

                <div class="mb-3">
                    <label for="voyageVehicule" class="form-label">Voyage Véhicule <span class="text-danger">*</span></label>
                    <select class="form-select" id="voyageVehicule" th:field="*{voyageVehicule.idVoyageVehicule}" required>
                        <option value="">Sélectionnez un voyage véhicule</option>
                        <option th:each="vv : ${voyageVehicules}" 
                                th:value="${vv.idVoyageVehicule}"
                                th:text="'VV #' + ${vv.idVoyageVehicule} + 
                                        (${vv.voyage != null && vv.voyage.trajet != null} ? 
                                        ' - ' + ${vv.voyage.trajet.gareRoutiereDepart?.ville?.nom} + ' → ' + ${vv.voyage.trajet.gareRoutiereArrivee?.ville?.nom} : '') +
                                        (${vv.voyage != null && vv.voyage.dateDepart != null} ? 
                                        ' - ' + ${#temporals.format(vv.voyage.dateDepart, 'dd/MM/yyyy')} : '') + 
                                        (${vv.voyage != null && vv.voyage.dateDepart != null} ? 
                                        ' - ' + ${vv.vehicule?.immatriculation} : '')
                                        ">
                        </option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="date" class="form-label">Date <span class="text-danger">*</span></label>
                    <input type="date" class="form-control" id="date" th:field="*{date}" required />
                </div>

                <div class="mb-3">
                    <label for="quantite" class="form-label">Quantité totale <span class="text-danger">*</span></label>
                    <input type="number" class="form-control" id="quantite" th:field="*{quantite}" min="0" required readonly style="background-color: #e9ecef; font-weight: bold;" />
                    <small class="text-muted">Calculé automatiquement à partir des quantités des produits</small>
                </div>

                <div class="mb-3">
                    <label class="form-label">Produits vendus <small class="text-muted">(Entrez la quantité pour chaque produit)</small></label>
                    <div class="card">
                        <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-sm table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Produit</th>
                                        <th style="width: 100px;">Prix unitaire</th>
                                        <th style="width: 120px;">Quantité</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="produit : ${produits}">
                                        <td>
                                            <span th:text="${produit.nom}"></span>
                                        </td>
                                        <td class="text-end">
                                            <span th:text="${#numbers.formatDecimal(produit.prix, 0, 'COMMA', 2, 'POINT')} + ' Ar'"></span>
                                        </td>
                                        <td>
                                            <input type="number" class="form-control form-control-sm quantite-produit" 
                                                   th:name="'quantites[' + ${produit.idProduit} + ']'"
                                                   th:value="${produitQuantites != null && produitQuantites.containsKey(produit.idProduit)} ? ${produitQuantites.get(produit.idProduit)} : 0"
                                                   min="0" placeholder="0" />
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <div th:if="${#lists.isEmpty(produits)}" class="text-muted text-center py-3">
                                Aucun produit disponible
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save"></i> Enregistrer
                    </button>
                    <a th:href="@{/admin/vente-produits}" class="btn btn-secondary">
                        <i class="bi bi-x-circle"></i> Annuler
                    </a>
                </div>
            </form>
        </div>
    </div>

    <script>
        (function() {
            // Fonction pour calculer la somme des quantités
            function calculerQuantiteTotale() {
                const inputs = document.querySelectorAll('.quantite-produit');
                let total = 0;
                
                inputs.forEach(input => {
                    const valeur = parseInt(input.value) || 0;
                    total += valeur;
                });
                
                document.getElementById('quantite').value = total;
            }
            
            // Écouter les changements sur tous les inputs de quantité
            document.addEventListener('DOMContentLoaded', function() {
                const inputs = document.querySelectorAll('.quantite-produit');
                
                inputs.forEach(input => {
                    input.addEventListener('input', calculerQuantiteTotale);
                    input.addEventListener('change', calculerQuantiteTotale);
                });
                
                // Calculer au chargement de la page
                calculerQuantiteTotale();
            });
        })();
    </script>
</main>
</body>
</html>
